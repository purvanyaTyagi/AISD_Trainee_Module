#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
from geometry_msgs.msg import Twist
import sys, select, termios, tty

msg = """
CONTROL 
---------------------------
w : Forward
s : Backward
a : Turn Left
d : Turn Right

Releasing keys stops the robot.
CTRL-C to quit
"""

class WASDTeleop(Node):
    def __init__(self):
        super().__init__('wasd_teleop')
        self.publisher_ = self.create_publisher(Twist, 'cmd_vel', 10)

        # CONFIGURATION
        self.speed = 0.5   # Linear speed (m/s)
        self.turn = 2.5    # Angular speed (rad/s) - High Sensitivity

        self.settings = termios.tcgetattr(sys.stdin)

    def getKey(self):
        # The timeout (0.1) defines how fast it stops when you release a key
        tty.setraw(sys.stdin.fileno())
        rlist, _, _ = select.select([sys.stdin], [], [], 0.1)
        if rlist:
            key = sys.stdin.read(1)
        else:
            key = ''
        termios.tcsetattr(sys.stdin, termios.TCSADRAIN, self.settings)
        return key

    def run(self):
        print(msg)
        try:
            while True:
                key = self.getKey()

                # Default: Stop if no key is pressed
                target_linear_vel = 0.0
                target_angular_vel = 0.0

                # Check inputs (Non-blocking)
                if key == 'w':
                    target_linear_vel = -self.speed  # W = Backward (Negative X)
                elif key == 's':
                    target_linear_vel = self.speed   # S = Forward (Positive X)
                elif key == 'a':
                    target_angular_vel = self.turn   # A = Left (Positive Z)
                elif key == 'd':
                    target_angular_vel = -self.turn  # D = Right (Negative Z)
                elif key == '\x03': # Ctrl-C
                    break

                # Publish
                twist = Twist()
                twist.linear.x = target_linear_vel
                twist.angular.z = target_angular_vel
                self.publisher_.publish(twist)

        except Exception as e:
            print(e)

        finally:
            # Force stop on exit
            twist = Twist()
            self.publisher_.publish(twist)
            termios.tcsetattr(sys.stdin, termios.TCSADRAIN, self.settings)

def main(args=None):
    rclpy.init(args=args)
    node = WASDTeleop()
    node.run()
    node.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()

